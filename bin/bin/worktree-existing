#!/usr/bin/env bash
set -e

# Usage: worktree-existing <project> <branch-name>
# Example: worktree-existing ClimbSmarter feat/ECOM-1234-checkout-flow

if [ "$#" -ne 2 ]; then
    echo "Usage: worktree-existing <project> <branch-name>"
    echo "Example: worktree-existing ClimbSmarter feat/ECOM-1234-checkout-flow"
    exit 1
fi

PROJECT="$1"
BRANCH_NAME="$2"

# Validate project directory
if [ ! -d "$PROJECT" ]; then
    echo "Error: Project directory '$PROJECT' does not exist"
    exit 1
fi

cd "$PROJECT"

# Validate git repo
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    echo "Error: '$PROJECT' is not a git repository"
    exit 1
fi

# Check for clean working directory
if ! git diff-index --quiet HEAD --; then
    echo "Error: Working directory is not clean. Commit or stash changes first."
    git status --short
    exit 1
fi

# Check if branch exists locally
if git show-ref --verify --quiet "refs/heads/$BRANCH_NAME"; then
    echo "Using local branch '$BRANCH_NAME'"
# Check if branch exists remotely
elif git show-ref --verify --quiet "refs/remotes/origin/$BRANCH_NAME"; then
    echo "Branch '$BRANCH_NAME' exists remotely, fetching and checking out..."
    git fetch origin "$BRANCH_NAME:$BRANCH_NAME"
else
    echo "Error: Branch '$BRANCH_NAME' does not exist locally or remotely"
    echo ""
    echo "Available local branches:"
    git branch --list
    echo ""
    echo "Available remote branches:"
    git branch -r --list "origin/$BRANCH_NAME*"
    exit 1
fi

# Convert branch name to worktree name (replace / with -)
WORKTREE_NAME="$PROJECT-${BRANCH_NAME//\//-}"
WORKTREE_PATH="../$WORKTREE_NAME"

echo "Creating worktree from existing branch..."
echo "  Branch: $BRANCH_NAME"
echo "  Worktree: $WORKTREE_PATH"
echo ""

# Check if worktree already exists
if [ -d "$WORKTREE_PATH" ]; then
    echo "Error: Worktree already exists at '$WORKTREE_PATH'"
    echo "Remove it first or choose a different name"
    exit 1
fi

# Create worktree
echo "Creating worktree..."
git worktree add "$WORKTREE_PATH" "$BRANCH_NAME"

# Copy env files if they exist
if ls .env* 1> /dev/null 2>&1; then
    echo "Copying .env files..."
    cp .env* "$WORKTREE_PATH/" 2>/dev/null || true
fi

# Initialize tmux session
echo "Initializing tmux session..."
dev-init -d "$WORKTREE_PATH"

echo ""
echo "âœ“ Worktree created and tmux session initialized!"
